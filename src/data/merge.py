import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from datetime import datetime

pd.set_option("display.max_columns", None)

df1 = pd.read_csv("../data/data_clean.csv")

df1["apoyo"] = np.where(df1.index < 50, 1, 0)

# Shuffle the rows and reset the index
df1 = df1.sample(frac=1).reset_index(drop=True)


df1 = df1.rename(columns={"padre": "papa"}, inplace=False)

variables = [
    "fecha_de_nacimiento",
    "nivel_de_estudio",
    "tipo_de_admision",
    "programa_de_pregrado",
    "papa",
    "progreso",
    "numero_de_matricula",
    "matricula_doble_titulacion",
    "programa_doble_titulacion",
    "porcentaje_progreso_doble_titulacion",
    "pbm",
    "estrato_socioeconomico",
    "solicitud_reubicacion_socioeconomica",
    "aprobacion_solicitud_reubicacion",
    "apoyo_economico",
    "fuente_de_apoyo",
    "otras_actividades_actuales",
    "involucramiento_anterior_bienestar",
    "tipo_involucramiento_anterior",
    "convocatorias_anteriores_bienestar",
    "confirmacion_postulacion",
    "creditos_inscritos_semestre",
    "categoria",
    "apoyo",
]

df1 = df1[variables]

df2 = pd.read_csv("../data/data_clean_2.csv")

df2.columns

df2["apoyo"] = np.where(df2.index < 50, 1, 0)

# Shuffle the rows and reset the index
df2 = df2.sample(frac=1).reset_index(drop=True)

# Concatenate the DataFrames based on common columns
df = pd.concat([df1, df2])

# Let's create a nice dataset for the model

# Convert "fecha_de_nacimiento" to datetime and calculate "edad"
df["fecha_de_nacimiento"] = pd.to_datetime(df["fecha_de_nacimiento"])
today = datetime.now().date()
df["edad"] = today.year - df["fecha_de_nacimiento"].dt.year

del df["fecha_de_nacimiento"]

# Delete 'nivel_de_estudio' and 'confirmacion_postulacion' columns
del df["nivel_de_estudio"]
del df["confirmacion_postulacion"]

# Replace bad data with NA, drop NA values, and convert to float
columns = ["papa", "numero_de_matricula", "estrato_socioeconomico", "pbm"]
for col in columns:
    df[col] = df[col].replace(["#VALUE!", "mal dato"], pd.NA)
    df = df.dropna(subset=[col])
    df[col] = df[col].astype(float)

# Replace certain values in 'aprobacion_solicitud_reubicacion'
df["aprobacion_solicitud_reubicacion"] = df["aprobacion_solicitud_reubicacion"].replace(
    "Aun sin resolucion", "No"
)

# Filter rows where 'edad' > 15 and 'papa' > 2
df = df[(df["edad"] > 15) & (df["papa"] > 2)]

# Convert 'No' values to 0 and other values to 1 in several columns
columns = [
    "solicitud_reubicacion_socioeconomica",
    "aprobacion_solicitud_reubicacion",
    "apoyo_economico",
    "involucramiento_anterior_bienestar",
]

for col in columns:
    df[col] = np.where(df[col] == "No", 0, 1)

# Generate the final csv file
df.to_csv("../data/final.csv", index=False)
